(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=i(t);fetch(t.href,s)}})();class O{constructor(e){this.entities=[],this.gravity=10,this.floor_height=20,this.ctx=e,this.canvas=e.canvas}update(e){this.entities.forEach(i=>{this.apply_gravity(i,e),this.apply_bounds(i),i.update(e)})}draw(e){this.entities.forEach(i=>{i.draw(e)})}apply_gravity(e,i){e.velocity.y+=this.gravity,e.position.y+=e.velocity.y*i.seconds_passed}apply_bounds(e){this.limit_left(e),this.limit_right(e),this.limit_bottom(e)}limit_left(e){e.position.x>=0||(e.position.x=0)}limit_right(e){const i=this.canvas.width-e.width;e.position.x<=i||(e.position.x=i)}limit_bottom(e){if(e.velocity.y<0)return;let i=this.canvas.height-this.floor_height-e.height;e.position.y<=i||(e.position.y=i,e.velocity.y=this.gravity,e.is_grounded=!0)}add_entity(e){e.ctx=this.ctx,this.entities.push(e)}add_player(e,i){e.stage=this,this.add_entity(e),e.init(i)}}function I(o){const e=o.file_extension??"png";for(const i in o.states){const n=o.states[i];n.images=[],n.indexes.forEach(t=>{let[s,a]=t;if(!a){const d=new Image;d.src=`${o.base_src+s}.${e}`,n.images.push(d);return}let c=s;if(s<a)for(;c<=a;){const d=new Image;d.src=`${o.base_src+c}.${e}`,n.images.push(d),c++}else if(s>a)for(;c>=a;){const d=new Image;d.src=`${o.base_src+c}.${e}`,n.images.push(d),c--}}),n.index=0,typeof n.time>"u"&&(n.time=60)}return o}function M(o){o.hooks.update.push(e=>A(o,e)),o.hooks.draw.push(e=>q(o,e))}function q(o,e){const i=o.get_sprite_state(),n=o.sprites_data.scale,{image_width:t,image_height:s}=o.sprites_data;let{x:a,y:c}=o.position;a+=o.sprites_data.offset.x,c+=o.sprites_data.offset.y,o.animation_offset&&(a+=o.animation_offset.x,c+=o.animation_offset.y),e.drawImage(i.images[i.index],0,0,t,s,a,c,t*n,s*n)}function A(o,e){const i=o.get_sprite_state();e.previous<o.animation_timer+i.time||(o.animation_timer=e.previous,i.index++,i.loop?i.index===i.images.length&&(i.index=0):i.index===i.images.length&&(i.index=i.images.length-1,o.animation_end(o.animation_state)))}function R(o){o.is_moving=!1,o.is_backward=!1,o.is_forward=!1,o.forward=()=>{o.is_moving=!0,o.is_forward=!0,o.velocity.x=o.move_speed,o.is_jumping||o.animate("forward")},o.backward=()=>{o.is_moving=!0,o.is_backward=!0,o.velocity.x=-o.move_speed,o.is_jumping||o.animate("backward")},o.move_stop=()=>{o.velocity.x=0,o.is_moving=!1,o.is_backward=!1,o.is_forward=!1,o.is_jumping||o.animate("idle")};function e(i){o.position.x+=o.velocity.x*i.seconds_passed}o.hooks.update.push(e)}function C(o){const e=o.stage,i=o.stage.canvas,n=i.height-e.floor_height,t=n-110;o.is_grounded=!1,o.is_jumping=!1;let s="";o.jump=()=>{o.is_jumping=!0,o.is_grounded=!1,o.velocity.y=-o.jump_force;let f=o.get_direction();f==="forward"?o.animate("jump_forward"):f==="backward"?o.animate("jump_backward"):o.animate("jump")};function a(){s!=="jumping_up"&&(o.velocity.y>=e.gravity||(s="jumping_up"))}function c(){o.velocity.y<=e.gravity||(s="falling_down")}function d(){s!=="falling_down"||o.position.y+o.height<t||(s="landing",o.animate("landing"))}function h(){s==="landing"&&o.is_grounded&&(s="landed",o.is_jumping=!1,o.animate("land"),typeof o.on_land=="function"&&o.on_land())}function g(){o.lock||(a(),c(),d(),h())}function m(f){f==="land"&&o.animate("idle")}function w(f){f.beginPath(),f.moveTo(0,t),f.lineTo(i.width,t),f.moveTo(0,n),f.lineTo(i.width,n),f.stroke()}o.hooks.update.push(g),o.hooks.animation_end.push(m),o.hooks.draw.push(w)}function F(o){o.is_crouching=!1,o.crouch=()=>{o.is_crouching=!0,o.is_moving&&(o.velocity.x=0),o.animate("crouch"),o.set_hitbox_offset(38)},o.crouch_end=()=>{o.set_hitbox_offset(0)}}function N(o){o.hitbox={top:0,right:0,bottom:0,left:0,width:0,height:0},o.hitbox_offset={top:0,right:0,bottom:0,left:0};function e(t=0,s=0,a=0,c=0){o.hitbox_offset={top:t,right:s,bottom:a,left:c}}function i(){o.hitbox={top:o.position.y+o.hitbox_offset.top,right:o.position.x+o.width+o.hitbox_offset.right,bottom:o.position.y+o.height-o.hitbox_offset.bottom,left:o.position.x+o.hitbox_offset.left,width:o.width-o.hitbox_offset.left-o.hitbox_offset.right,height:o.height-o.hitbox_offset.top-o.hitbox_offset.bottom}}function n(t){t.save(),t.strokeStyle="red",t.strokeRect(o.hitbox.left,o.hitbox.top,o.hitbox.width,o.hitbox.height),t.restore()}o.set_hitbox_offset=e,o.hooks.update.push(i),o.hooks.draw.push(n)}function z(o){function e(i){i.strokeRect(o.position.x,o.position.y,o.width,o.height)}o.hooks.draw.push(e)}const k={P1:{KeyA:"backward",KeyD:"forward",KeyS:"crouch",Space:"jump",KeyJ:"attack_1",KeyK:"attack_2",KeyL:"attack_3"}};function D(o){const e={forward:!1,backward:!1,crouch:!1},i={forward:t,backward:a,crouch:h,jump:w,attack_1:f,attack_2:L,attack_3:K},n={forward_end:s,backward_end:c,crouch_end:g};function t(){e.forward=!0,!e.crouch&&o.forward()}function s(){e.forward=!1,!o.lock&&d()}function a(){e.backward=!0,!e.crouch&&o.backward()}function c(){e.backward=!1,!o.lock&&d()}function d(){return e.forward?(t(),!0):e.backward?(a(),!0):(o.move_stop(),!1)}function h(){e.crouch=!0,!o.is_jumping&&o.crouch()}function g(){e.crouch=!1,!o.lock&&(o.crouch_end(),d())}function m(){return e.crouch?(h(),!0):!1}function w(){o.is_jumping||(o.jump(),o.on_land=()=>{o.on_land=null,!m()&&d()})}function f(){}function L(){}function K(){}document.addEventListener("keydown",b=>{if(o.lock||!k[o.pid])return;const u=k[o.pid][b.code];typeof i[u]=="function"&&i[u]()}),document.addEventListener("keyup",b=>{if(!k[o.pid])return;const u=k[o.pid][b.code];typeof n[u+"_end"]=="function"&&n[u+"_end"]()})}class J{constructor(){this.hooks={init:[],update:[],animation_end:[],draw:[]}}load_sprite(e){this.sprites_data=I(e)}init(e){this.width=this.sprites_data.width,this.height=this.sprites_data.height,this.pid=e.pid??"P1",this.animation_state="idle",this.animation_timer=0,this.animation_offset=null,this.position=e.position??{x:0,y:0},this.velocity={x:0,y:0},this.move_speed=400,this.jump_force=700,M(this),N(this),R(this),F(this),C(this),z(this),this.hooks.init.forEach(i=>i(this)),D(this)}update(e){this.hooks.update.forEach(i=>i(e))}draw(e){this.hooks.draw.forEach(i=>i(e))}get_sprite_state(){return this.sprites_data.states[this.animation_state]}animate(e,i=null){this.animation_state!==e&&(this.animation_offset=i,this.animation_state=e,this.sprites_data.states[this.animation_state].index=0)}animation_end(e){this.hooks.animation_end.forEach(i=>i(e))}get_direction(){return this.velocity.x>0?"forward":this.velocity.x<0?"backward":!1}}const Q="spiderman",V="sprites/spiderman/MVC2_SpiderMan_",B=1,G={x:-280,y:-210},H=60,U=80,W=640,X=480,Y={idle:{loop:!0,indexes:[[159,167]]},forward:{loop:!0,indexes:[[169,180]]},backward:{loop:!0,indexes:[[180,169]]},jump:{indexes:[[198,195],[189,195]]},jump_forward:{indexes:[[200,210]]},jump_backward:{indexes:[[711,722]]},falling:{indexes:[[189,195]]},land:{indexes:[[196,199]]},landing:{indexes:[[193,199]]},crouch:{indexes:[[217,220]]},web_line_shoot:{indexes:[[572]]},web_swing:{indexes:[[573,577]]}},Z={id:Q,base_src:V,scale:B,offset:G,width:H,height:U,image_width:W,image_height:X,states:Y};function y(o){const e=o.stage.canvas;let i,n,t=!1,s={start:!1,line_end:!1,length:0,velocity:400,acceleration:0,acceleration_rate:800,origin_offset:{x:5,y:-32}},a={velocity:7e4,acceleration:1500,acceleration_rate:150,destination:{}},c=e.width-o.width;o.web_swing=()=>{o.jump(),setTimeout(()=>{m()},150)};function d(r){g(),w(r),b(r)}function h(r){f(r),$(r)}function g(){t&&(o.velocity.y=0,o.position.y=n)}function m(){t=!0,o.lock=!0,o.move_stop(),o.animate("web_line_shoot"),n=o.position.y,s.length=0,s.line_end=!1,s.start=!0,s.angle=5.5,s.origin={x:o.position.x+o.width+s.origin_offset.x,y:o.position.y+s.origin_offset.y}}function w(r){if(!s.start||s.line_end)return;s.acceleration=(s.acceleration+s.acceleration_rate)*r.seconds_passed,s.length+=(s.velocity+s.acceleration_rate)*r.seconds_passed;let{length:l,angle:x,origin:v}=s;s.current={x:v.x+l*Math.cos(x),y:v.y+l*Math.sin(x)},L()}function f(r){s.start&&(r.save(),r.strokeStyle="cyan",r.beginPath(),r.moveTo(s.origin.x,s.origin.y),r.lineTo(s.current.x,s.current.y),r.stroke(),r.restore())}function L(){s.current.y>0&&s.current.x<e.width||(s.line_end=!0,K())}function K(){i="swing",o.animate("web_swing");let r=o.position.x+o.width,l=(s.current.x-r)*2;a.acceleration=1500,a.destination={x:r+l,y:o.position.y}}function b(r){if(i==="swing"){if(a.acceleration=a.acceleration*a.acceleration_rate*r.seconds_passed,console.log(a.acceleration),o.velocity.x=(a.velocity+a.acceleration)*r.seconds_passed,o.position.x>=c){o.position.x=c,u();return}o.position.x>=a.destination.x&&(o.position.x=a.destination.x,u())}}function u(){i="",o.velocity.x=0,t=!1,o.lock=!1,o.animate("falling")}function $(r){if(i!=="swing")return;let{x:l,y:x}=a.destination,{width:v,height:T}=o;r.save(),r.strokeStyle="red",r.strokeRect(l,x,v,T),r.restore()}o.hooks.update.push(d),o.hooks.draw.unshift(h)}const j={P1:{KeyK:"web_swing"}};function oo(o){const e={web_swing:i};function i(){o.web_swing()}document.addEventListener("keydown",n=>{if(o.lock||!j[o.pid])return;let t=j[o.pid][n.code];typeof e[t]=="function"&&e[t]()}),document.addEventListener("keyup",n=>{if(!j[o.pid])return;let t=j[o.pid][n.code];typeof e[t+"_end"]=="function"&&e[t+"_end"]()})}class eo extends J{constructor(e={}){super(),this.load_sprite(Z),this.hooks.init.push(()=>{y(this)}),oo(this)}}const E={previous:0,seconds_passed:0};let _,p,S;function io(){no(),so(),requestAnimationFrame(P)}window.addEventListener("load",io);function so(){S=new O(p),S.add_player(new eo,{pid:"P1"})}function to(o){S.update(o)}function ao(o){o.clearRect(0,0,_.width,_.height),S.draw(o)}function no(){_=document.querySelector("canvas"),_.width=1e3,_.height=500,p=_.getContext("2d"),p.strokeStyle="green",p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high"}function P(o){E.seconds_passed=(o-E.previous)/1e3,E.previous=o,to(E),ao(p),requestAnimationFrame(P)}
