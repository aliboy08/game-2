(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(t){if(t.ep)return;t.ep=!0;const s=e(t);fetch(t.href,s)}})();class O{constructor(o){this.entities=[],this.gravity=8,this.floor_height=20,this.ctx=o,this.canvas=o.canvas}update(o){this.entities.forEach(e=>{this.apply_gravity(e,o),this.apply_bounds(e),e.update(o)})}draw(o){this.entities.forEach(e=>{e.draw(o)})}apply_gravity(o,e){o.velocity.y+=this.gravity,o.position.y+=o.velocity.y*e.seconds_passed}apply_bounds(o){this.limit_left(o),this.limit_right(o),this.limit_bottom(o)}limit_left(o){o.position.x>=0||(o.position.x=0)}limit_right(o){const e=this.canvas.width-o.width;o.position.x<=e||(o.position.x=e)}limit_bottom(o){if(o.velocity.y<0)return;let e=this.canvas.height-this.floor_height-o.height;o.position.y<=e||(o.position.y=e,o.velocity.y=this.gravity,o.is_grounded=!0)}add_entity(o){o.ctx=this.ctx,this.entities.push(o)}add_player(o,e){o.stage=this,this.add_entity(o),o.init(e)}}function I(i){const o=i.file_extension??"png";for(const e in i.states){const n=i.states[e];n.images=[],n.indexes.forEach(t=>{let[s,r]=t;if(!r){const d=new Image;d.src=`${i.base_src+s}.${o}`,n.images.push(d);return}let c=s;if(s<r)for(;c<=r;){const d=new Image;d.src=`${i.base_src+c}.${o}`,n.images.push(d),c++}else if(s>r)for(;c>=r;){const d=new Image;d.src=`${i.base_src+c}.${o}`,n.images.push(d),c--}}),n.index=0,typeof n.time>"u"&&(n.time=60)}return i}function M(i){i.hooks.update.push(o=>A(i,o)),i.hooks.draw.push(o=>q(i,o))}function q(i,o){const e=i.get_sprite_state(),n=i.sprites_data.scale,{image_width:t,image_height:s}=i.sprites_data;let{x:r,y:c}=i.position;r+=i.sprites_data.offset.x,c+=i.sprites_data.offset.y,i.animation_offset&&(r+=i.animation_offset.x,c+=i.animation_offset.y),o.drawImage(e.images[e.index],0,0,t,s,r,c,t*n,s*n)}function A(i,o){const e=i.get_sprite_state();o.previous<i.animation_timer+e.time||(i.animation_timer=o.previous,e.index++,e.loop?e.index===e.images.length&&(e.index=0):e.index===e.images.length&&(e.index=e.images.length-1,i.animation_end(i.animation_state)))}function R(i){i.is_moving=!1,i.is_backward=!1,i.is_forward=!1,i.forward=()=>{i.is_moving=!0,i.is_forward=!0,i.velocity.x=i.move_speed,i.is_jumping||i.animate("forward")},i.backward=()=>{i.is_moving=!0,i.is_backward=!0,i.velocity.x=-i.move_speed,i.is_jumping||i.animate("backward")},i.move_stop=()=>{i.velocity.x=0,i.is_moving=!1,i.is_backward=!1,i.is_forward=!1,i.is_jumping||i.animate("idle")};function o(){i.position.x+=i.velocity.x}i.hooks.update.push(o)}function C(i){const o=i.stage,e=i.stage.canvas,n=e.height-o.floor_height,t=n-110;i.is_grounded=!1,i.is_jumping=!1;let s="";i.jump=()=>{i.is_jumping=!0,i.is_grounded=!1,i.velocity.y=-i.jump_force;let f=i.get_direction();f==="forward"?i.animate("jump_forward"):f==="backward"?i.animate("jump_backward"):i.animate("jump")};function r(){s!=="jumping_up"&&(i.velocity.y>=o.gravity||(s="jumping_up"))}function c(){i.velocity.y<=o.gravity||(s="falling_down")}function d(){s!=="falling_down"||i.position.y+i.height<t||(s="landing",i.animate("landing"))}function h(){s==="landing"&&i.is_grounded&&(s="landed",i.is_jumping=!1,i.animate("land"),typeof i.on_land=="function"&&i.on_land())}function g(){i.lock||(r(),c(),d(),h())}function m(f){f==="land"&&i.animate("idle")}function w(f){f.beginPath(),f.moveTo(0,t),f.lineTo(e.width,t),f.moveTo(0,n),f.lineTo(e.width,n),f.stroke()}i.hooks.update.push(g),i.hooks.animation_end.push(m),i.hooks.draw.push(w)}function F(i){i.is_crouching=!1,i.crouch=()=>{i.is_crouching=!0,i.is_moving&&(i.velocity.x=0),i.animate("crouch"),i.set_hitbox_offset(38)},i.crouch_end=()=>{i.set_hitbox_offset(0)}}function N(i){i.hitbox={top:0,right:0,bottom:0,left:0,width:0,height:0},i.hitbox_offset={top:0,right:0,bottom:0,left:0};function o(t=0,s=0,r=0,c=0){i.hitbox_offset={top:t,right:s,bottom:r,left:c}}function e(){i.hitbox={top:i.position.y+i.hitbox_offset.top,right:i.position.x+i.width+i.hitbox_offset.right,bottom:i.position.y+i.height-i.hitbox_offset.bottom,left:i.position.x+i.hitbox_offset.left,width:i.width-i.hitbox_offset.left-i.hitbox_offset.right,height:i.height-i.hitbox_offset.top-i.hitbox_offset.bottom}}function n(t){t.save(),t.strokeStyle="red",t.strokeRect(i.hitbox.left,i.hitbox.top,i.hitbox.width,i.hitbox.height),t.restore()}i.set_hitbox_offset=o,i.hooks.update.push(e),i.hooks.draw.push(n)}function z(i){function o(e){e.strokeRect(i.position.x,i.position.y,i.width,i.height)}i.hooks.draw.push(o)}const v={P1:{KeyA:"backward",KeyD:"forward",KeyS:"crouch",Space:"jump",KeyJ:"attack_1",KeyK:"attack_2",KeyL:"attack_3"}};function D(i){const o={forward:!1,backward:!1,crouch:!1},e={forward:t,backward:r,crouch:h,jump:w,attack_1:f,attack_2:S,attack_3:L},n={forward_end:s,backward_end:c,crouch_end:g};function t(){o.forward=!0,!o.crouch&&i.forward()}function s(){o.forward=!1,!i.lock&&d()}function r(){o.backward=!0,!o.crouch&&i.backward()}function c(){o.backward=!1,!i.lock&&d()}function d(){return o.forward?(t(),!0):o.backward?(r(),!0):(i.move_stop(),!1)}function h(){o.crouch=!0,!i.is_jumping&&i.crouch()}function g(){o.crouch=!1,!i.lock&&(i.crouch_end(),d())}function m(){return o.crouch?(h(),!0):!1}function w(){i.is_jumping||(i.jump(),i.on_land=()=>{i.on_land=null,!m()&&d()})}function f(){}function S(){}function L(){}document.addEventListener("keydown",b=>{if(i.lock||!v[i.pid])return;const u=v[i.pid][b.code];typeof e[u]=="function"&&e[u]()}),document.addEventListener("keyup",b=>{if(!v[i.pid])return;const u=v[i.pid][b.code];typeof n[u+"_end"]=="function"&&n[u+"_end"]()})}class J{constructor(){this.hooks={init:[],update:[],animation_end:[],draw:[]}}load_sprite(o){this.sprites_data=I(o)}init(o){this.width=this.sprites_data.width,this.height=this.sprites_data.height,this.pid=o.pid??"P1",this.animation_state="idle",this.animation_timer=0,this.animation_offset=null,this.position=o.position??{x:0,y:0},this.velocity={x:0,y:0},this.move_speed=3,this.jump_force=700,M(this),N(this),R(this),F(this),C(this),z(this),this.hooks.init.forEach(e=>e(this)),D(this)}update(o){this.hooks.update.forEach(e=>e(o))}draw(o){this.hooks.draw.forEach(e=>e(o))}get_sprite_state(){return this.sprites_data.states[this.animation_state]}animate(o,e=null){this.animation_state!==o&&(this.animation_offset=e,e&&console.log("set animation offset",this.animation_offset),this.animation_state=o,this.sprites_data.states[this.animation_state].index=0)}animation_end(o){this.hooks.animation_end.forEach(e=>e(o))}get_direction(){return this.velocity.x>0?"forward":this.velocity.x<0?"backward":!1}}const Q="spiderman",V="sprites/spiderman/MVC2_SpiderMan_",B=1,G={x:-280,y:-210},H=60,U=80,W=640,X=480,Y={idle:{loop:!0,indexes:[[159,167]]},forward:{loop:!0,indexes:[[169,180]]},backward:{loop:!0,indexes:[[180,169]]},jump:{indexes:[[198,195],[189,195]]},jump_forward:{indexes:[[200,210]]},jump_backward:{indexes:[[711,722]]},falling:{indexes:[[189,195]]},land:{indexes:[[196,199]]},landing:{indexes:[[193,199]]},crouch:{indexes:[[217,220]]},web_line_shoot:{indexes:[[572]]},web_swing:{indexes:[[573,577]]}},Z={id:Q,base_src:V,scale:B,offset:G,width:H,height:U,image_width:W,image_height:X,states:Y};function y(i){const o=i.stage.canvas;let e,n,t=!1,s={start:!1,line_end:!1,length:0,velocity:5,origin_offset:{x:5,y:-32}},r={velocity:6,destination:{}},c=o.width-i.width;i.web_swing=()=>{i.jump(),setTimeout(()=>{m()},150)};function d(a){g(),w(),b()}function h(a){f(a),P(a)}function g(){t&&(i.velocity.y=0,i.position.y=n)}function m(){t=!0,i.lock=!0,i.move_stop(),i.animate("web_line_shoot"),n=i.position.y,s.length=0,s.line_end=!1,s.start=!0,s.angle=5.5,s.origin={x:i.position.x+i.width+s.origin_offset.x,y:i.position.y+s.origin_offset.y}}function w(){if(!s.start||s.line_end)return;s.length+=s.velocity;let{length:a,angle:l,origin:x}=s;s.current={x:x.x+a*Math.cos(l),y:x.y+a*Math.sin(l)},S()}function f(a){s.start&&(a.save(),a.strokeStyle="cyan",a.beginPath(),a.moveTo(s.origin.x,s.origin.y),a.lineTo(s.current.x,s.current.y),a.stroke(),a.restore())}function S(){s.current.y>0&&s.current.x<o.width||(s.line_end=!0,L())}function L(){e="swing",i.animate("web_swing");let a=i.position.x+i.width,l=(s.current.x-a)*2;r.destination={x:a+l,y:i.position.y}}function b(a){if(e==="swing"){if(i.velocity.x=r.velocity,i.position.x>=c){i.position.x=c,u();return}i.position.x>=r.destination.x&&(i.position.x=r.destination.x,u())}}function u(){e="",i.velocity.x=0,t=!1,i.lock=!1,i.animate("falling")}function P(a){if(e!=="swing")return;let{x:l,y:x}=r.destination,{width:$,height:T}=i;a.save(),a.strokeStyle="red",a.strokeRect(l,x,$,T),a.restore()}i.hooks.update.push(d),i.hooks.draw.unshift(h)}const k={P1:{KeyK:"web_swing"}};function ii(i){const o={web_swing:e};function e(){i.web_swing()}document.addEventListener("keydown",n=>{if(i.lock||!k[i.pid])return;let t=k[i.pid][n.code];typeof o[t]=="function"&&o[t]()}),document.addEventListener("keyup",n=>{if(!k[i.pid])return;let t=k[i.pid][n.code];typeof o[t+"_end"]=="function"&&o[t+"_end"]()})}class oi extends J{constructor(o={}){super(),this.load_sprite(Z),this.hooks.init.push(()=>{y(this)}),ii(this)}}const j={previous:0,seconds_passed:0};let _,p,E;function ei(){ri(),si(),requestAnimationFrame(K)}window.addEventListener("load",ei);function si(){E=new O(p),E.add_player(new oi,{pid:"P1"})}function ti(i){E.update(i)}function ni(i){i.clearRect(0,0,_.width,_.height),E.draw(i)}function ri(){_=document.querySelector("canvas"),_.width=1e3,_.height=500,p=_.getContext("2d"),p.strokeStyle="green",p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high"}function K(i){j.seconds_passed=(i-j.previous)/1e3,j.previous=i,requestAnimationFrame(K),ti(j),ni(p)}
