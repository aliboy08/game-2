(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&a(r)}).observe(document,{childList:!0,subtree:!0});function s(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(t){if(t.ep)return;t.ep=!0;const o=s(t);fetch(t.href,o)}})();class O{constructor(i){this.entities=[],this.gravity=10,this.floor_height=20,this.ctx=i,this.canvas=i.canvas}update(i){this.entities.forEach(s=>{this.apply_gravity(s,i),this.apply_bounds(s),s.update(i)})}draw(i){this.entities.forEach(s=>{s.draw(i)})}apply_gravity(i,s){i.velocity.y+=this.gravity,i.position.y+=i.velocity.y*s.seconds_passed}apply_bounds(i){this.limit_left(i),this.limit_right(i),this.limit_bottom(i)}limit_left(i){i.position.x>=0||(i.position.x=0)}limit_right(i){const s=this.canvas.width-i.width;i.position.x<=s||(i.position.x=s)}limit_bottom(i){if(i.velocity.y<0)return;let s=this.canvas.height-this.floor_height-i.height;i.position.y<=s||(i.position.y=s,i.velocity.y=this.gravity,i.is_grounded=!0)}add_entity(i){i.ctx=this.ctx,this.entities.push(i)}add_player(i,s){i.stage=this,this.add_entity(i),i.init(s)}}function z(e){const i=e.file_extension??"png";for(const s in e.states){const a=e.states[s];a.images=[],a.indexes.forEach(t=>{let[o,r]=t;if(!r){const d=new Image;d.src=`${e.base_src+o}.${i}`,a.images.push(d);return}let n=o;if(o<r)for(;n<=r;){const d=new Image;d.src=`${e.base_src+n}.${i}`,a.images.push(d),n++}else if(o>r)for(;n>=r;){const d=new Image;d.src=`${e.base_src+n}.${i}`,a.images.push(d),n--}}),a.index=0,typeof a.time>"u"&&(a.time=60)}return e}function I(e){e.hooks.update.push(i=>q(e,i)),e.hooks.draw.push(i=>M(e,i))}function M(e,i){const s=e.get_sprite_state(),a=e.sprites_data.scale,{image_width:t,image_height:o}=e.sprites_data;let{x:r,y:n}=e.position;r+=e.sprites_data.offset.x,n+=e.sprites_data.offset.y,e.animation_offset&&(r+=e.animation_offset.x,n+=e.animation_offset.y),i.drawImage(s.images[s.index],0,0,t,o,r,n,t*a,o*a)}function q(e,i){const s=e.get_sprite_state();i.previous<e.animation_timer+s.time||(e.animation_timer=i.previous,s.index++,s.loop?s.index===s.images.length&&(s.index=0):s.index===s.images.length&&(s.index=s.images.length-1,e.animation_end(e.animation_state)))}function A(e){e.is_moving=!1,e.is_backward=!1,e.is_forward=!1,e.forward=()=>{e.is_moving=!0,e.is_forward=!0,e.velocity.x=e.move_speed,e.is_jumping||e.animate("forward")},e.backward=()=>{e.is_moving=!0,e.is_backward=!0,e.velocity.x=-e.move_speed,e.is_jumping||e.animate("backward")},e.move_stop=()=>{e.velocity.x=0,e.is_moving=!1,e.is_backward=!1,e.is_forward=!1,e.is_jumping||e.animate("idle")};function i(s){e.position.x+=e.velocity.x*s.seconds_passed}e.hooks.update.push(i)}function R(e){const i=e.stage,s=e.stage.canvas,a=s.height-i.floor_height,t=a-110;e.is_grounded=!1,e.is_jumping=!1;let o="";e.jump=()=>{e.is_jumping=!0,e.is_grounded=!1,e.velocity.y=-e.jump_force;let u=e.get_direction();u==="forward"?e.animate("jump_forward"):u==="backward"?e.animate("jump_backward"):e.animate("jump")};function r(){o!=="jumping_up"&&(e.velocity.y>=i.gravity||(o="jumping_up"))}function n(){e.velocity.y<=i.gravity||(o="falling_down")}function d(){o!=="falling_down"||e.position.y+e.height<t||(o="landing",e.animate("landing"))}function _(){o==="landing"&&e.is_grounded&&(o="landed",e.is_jumping=!1,e.animate("land"),typeof e.on_land=="function"&&e.on_land())}function g(){e.lock||(r(),n(),d(),_())}function m(u){u==="land"&&e.animate("idle")}function w(u){u.beginPath(),u.moveTo(0,t),u.lineTo(s.width,t),u.moveTo(0,a),u.lineTo(s.width,a),u.stroke()}e.hooks.update.push(g),e.hooks.animation_end.push(m),e.hooks.draw.push(w)}function C(e){e.is_crouching=!1,e.crouch=()=>{e.is_crouching=!0,e.is_moving&&(e.velocity.x=0),e.animate("crouch"),e.set_hitbox_offset(38)},e.crouch_end=()=>{e.set_hitbox_offset(0)}}function F(e){e.hitbox={top:0,right:0,bottom:0,left:0,width:0,height:0},e.hitbox_offset={top:0,right:0,bottom:0,left:0};function i(t=0,o=0,r=0,n=0){e.hitbox_offset={top:t,right:o,bottom:r,left:n}}function s(){e.hitbox={top:e.position.y+e.hitbox_offset.top,right:e.position.x+e.width+e.hitbox_offset.right,bottom:e.position.y+e.height-e.hitbox_offset.bottom,left:e.position.x+e.hitbox_offset.left,width:e.width-e.hitbox_offset.left-e.hitbox_offset.right,height:e.height-e.hitbox_offset.top-e.hitbox_offset.bottom}}function a(t){t.save(),t.strokeStyle="red",t.strokeRect(e.hitbox.left,e.hitbox.top,e.hitbox.width,e.hitbox.height),t.restore()}e.set_hitbox_offset=i,e.hooks.update.push(s),e.hooks.draw.push(a)}function N(e){function i(s){s.strokeRect(e.position.x,e.position.y,e.width,e.height)}e.hooks.draw.push(i)}const j={P1:{KeyA:"backward",KeyD:"forward",KeyS:"crouch",Space:"jump",KeyJ:"attack_1",KeyK:"attack_2",KeyL:"attack_3"}};function W(e){const i={forward:!1,backward:!1,crouch:!1},s={forward:t,backward:r,crouch:_,jump:w,attack_1:u,attack_2:L,attack_3:P},a={forward_end:o,backward_end:n,crouch_end:g};function t(){i.forward=!0,!i.crouch&&e.forward()}function o(){i.forward=!1,!e.lock&&d()}function r(){i.backward=!0,!i.crouch&&e.backward()}function n(){i.backward=!1,!e.lock&&d()}function d(){return i.forward?(t(),!0):i.backward?(r(),!0):(e.move_stop(),!1)}function _(){i.crouch=!0,!e.is_jumping&&e.crouch()}function g(){i.crouch=!1,!e.lock&&(e.crouch_end(),d())}function m(){return i.crouch?(_(),!0):!1}function w(){e.is_jumping||(e.jump(),e.on_land=()=>{e.on_land=null,!m()&&d()})}function u(){}function L(){}function P(){}document.addEventListener("keydown",b=>{if(e.lock||!j[e.pid])return;const f=j[e.pid][b.code];typeof s[f]=="function"&&s[f]()}),document.addEventListener("keyup",b=>{if(!j[e.pid])return;const f=j[e.pid][b.code];typeof a[f+"_end"]=="function"&&a[f+"_end"]()})}class D{constructor(){this.hooks={init:[],update:[],animation_end:[],draw:[]}}load_sprite(i){this.sprites_data=z(i)}init(i){this.width=this.sprites_data.width,this.height=this.sprites_data.height,this.pid=i.pid??"P1",this.animation_state="idle",this.animation_timer=0,this.animation_offset=null,this.position=i.position??{x:0,y:0},this.velocity={x:0,y:0},this.move_speed=400,this.jump_force=700,I(this),F(this),A(this),C(this),R(this),N(this),this.hooks.init.forEach(s=>s(this)),W(this)}update(i){this.hooks.update.forEach(s=>s(i))}draw(i){this.hooks.draw.forEach(s=>s(i))}get_sprite_state(){return this.sprites_data.states[this.animation_state]}animate(i,s=null){this.animation_state!==i&&(this.animation_offset=s,this.animation_state=i,this.sprites_data.states[this.animation_state].index=0)}animation_end(i){this.hooks.animation_end.forEach(s=>s(i))}get_direction(){return this.velocity.x>0?"forward":this.velocity.x<0?"backward":!1}}const J="spiderman",Q="sprites/spiderman/MVC2_SpiderMan_",V=1,B={x:-280,y:-210},G=60,H=80,U=640,X=480,Y={idle:{loop:!0,indexes:[[159,167]]},forward:{loop:!0,indexes:[[169,180]]},backward:{loop:!0,indexes:[[180,169]]},jump:{indexes:[[198,195],[189,195]]},jump_forward:{indexes:[[200,210]]},jump_backward:{indexes:[[711,722]]},falling:{indexes:[[189,195]]},land:{indexes:[[196,199]]},landing:{indexes:[[193,199]]},crouch:{indexes:[[217,220]]},web_line_shoot:{indexes:[[572]]},web_swing:{indexes:[[573,577]]},web_line_up_shoot:{indexes:[[670,671]]},web_line_up_grab:{indexes:[[321]]}},Z={id:J,base_src:Q,scale:V,offset:B,width:G,height:H,image_width:U,image_height:X,states:Y};function y(e){const i=e.stage.canvas;let s,a,t=!1,o={start:!1,line_end:!1,length:0,velocity:2e3,velocity_min:2,deceleration:{initial:200,current:0,rate:4e3},origin_offset:{x:5,y:-32}},r={velocity:7e4,acceleration:1500,acceleration_rate:150,destination:{}},n=i.width-e.width;e.web_swing=()=>{e.jump(),setTimeout(()=>{m()},150)};function d(c){g(),w(c),b(c)}function _(c){u(c),$(c)}function g(){t&&(e.velocity.y=0,e.position.y=a)}function m(){t=!0,e.lock=!0,e.move_stop(),e.animate("web_line_shoot"),a=e.position.y,o.length=0,o.line_end=!1,o.start=!0,o.angle=5.5,o.origin={x:e.position.x+e.width+o.origin_offset.x,y:e.position.y+o.origin_offset.y},o.deceleration.current=o.deceleration.initial}function w(c){if(!o.start||o.line_end)return;o.deceleration.current+=o.deceleration.rate*c.seconds_passed;let l=(o.velocity-o.deceleration.current)*c.seconds_passed;l<o.velocity_min&&(l=o.velocity_min),console.log(l),o.length+=l;let{length:v,angle:x,origin:k}=o;o.current={x:k.x+v*Math.cos(x),y:k.y+v*Math.sin(x)},L()}function u(c){o.start&&(c.save(),c.strokeStyle="cyan",c.beginPath(),c.moveTo(o.origin.x,o.origin.y),c.lineTo(o.current.x,o.current.y),c.stroke(),c.restore())}function L(){o.current.y>0&&o.current.x<i.width||(o.line_end=!0,P())}function P(){s="swing",e.animate("web_swing");let c=e.position.x+e.width,l=(o.current.x-c)*2;r.acceleration=1500,r.destination={x:c+l,y:e.position.y}}function b(c){if(s==="swing"){if(r.acceleration=r.acceleration*r.acceleration_rate*c.seconds_passed,e.velocity.x=(r.velocity+r.acceleration)*c.seconds_passed,e.position.x>=n){e.position.x=n,f();return}e.position.x>=r.destination.x&&(e.position.x=r.destination.x,f())}}function f(){s="",e.velocity.x=0,t=!1,e.lock=!1,e.animate("falling")}function $(c){if(s!=="swing")return;let{x:l,y:v}=r.destination,{width:x,height:k}=e;c.save(),c.strokeStyle="red",c.strokeRect(l,v,x,k),c.restore()}e.hooks.update.push(d),e.hooks.draw.unshift(_)}function ee(e){const i={start:!1,line_complete:!1,offset:{x:7,y:-60},velocity:1800,velocity_min:2,deceleration:{initial:100,current:0,rate:4e3}};e.web_zip_up=()=>{t()};function s(n){o(n)}function a(n){r(n)}function t(){console.log("web_line_start"),e.animate("web_line_up_shoot"),i.start=!0,i.line_complete=!1,i.length=0,i.deceleration.current=i.deceleration.initial,i.origin={x:e.position.x+e.width/2+i.offset.x,y:e.position.y+e.width/2+i.offset.y},i.current={x:i.origin.x,y:i.origin.y}}function o(n){if(!i.start||i.line_complete)return;i.deceleration.current+=i.deceleration.rate*n.seconds_passed;let d=(i.velocity-i.deceleration.current)*n.seconds_passed;d<i.velocity_min&&(d=i.velocity_min),i.current.y-=d,i.current.y<=0&&(i.line_complete=!0)}function r(n){i.start&&(n.save(),n.strokeStyle="cyan",n.beginPath(),n.moveTo(i.origin.x,i.origin.y),n.lineTo(i.current.x,i.current.y),n.stroke(),n.restore())}e.hooks.update.push(s),e.hooks.draw.unshift(a)}const E={P1:{KeyK:"web_moves"}};function ie(e){const i={KeyW:!1},s={web_moves:a};function a(){i.KeyW?e.web_zip_up():e.web_swing()}document.addEventListener("keydown",t=>{if(i[t.code]=!0,e.lock||!E[e.pid])return;let o=E[e.pid][t.code];typeof s[o]=="function"&&s[o]()}),document.addEventListener("keyup",t=>{if(i[t.code]=!1,!E[e.pid])return;let o=E[e.pid][t.code];typeof s[o+"_end"]=="function"&&s[o+"_end"]()})}class oe extends D{constructor(i={}){super(),this.load_sprite(Z),this.hooks.init.push(()=>{y(this),ee(this)}),ie(this)}}const S={previous:0,seconds_passed:0};let h,p,K;function se(){ae(),te(),requestAnimationFrame(T)}window.addEventListener("load",se);function te(){K=new O(p),K.add_player(new oe,{pid:"P1"})}function ne(e){K.update(e)}function re(e){e.clearRect(0,0,h.width,h.height),K.draw(e)}function ae(){h=document.querySelector("canvas"),h.width=1e3,h.height=500,p=h.getContext("2d"),p.strokeStyle="green",p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high"}function T(e){S.seconds_passed=(e-S.previous)/1e3,S.previous=e,ne(S),re(p),requestAnimationFrame(T)}
